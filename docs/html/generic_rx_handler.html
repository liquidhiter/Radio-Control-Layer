<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Radio Control Layer (RCL): Generic Rx Command Handler</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Radio Control Layer (RCL)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('generic_rx_handler.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Generic Rx Command Handler </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Introduction</h1>
<p>The generic Rx command allows to receive packets at a specific RF frequency and with a specific syncword. The following sections describe how the command can be configured and used, its life cycle, and how it fits into the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> architecture.</p>
<p>In order to submit a Generic Rx command, the following steps must have taken place:</p>
<ol type="1">
<li><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> has been initialized (See <a class="el" href="_r_c_l_8h.html#a0dba4dc6bc994b9f25813b3ed6d975c2" title="Initializes the RCL driver state. ">RCL_init</a>) and a handle must exist (See <a class="el" href="_r_c_l_8h.html#ad250dbda0747820e489d38cdb268ecee" title="Initializes an RCL client instance. ">RCL_open</a>).</li>
<li>The <a class="el" href="commands_2generic_8h.html#struct_r_c_l___c_m_d___g_e_n_e_r_i_c___r_x__t" title="Generic receive command. ">RCL_CMD_GENERIC_RX_t</a> command has been initialized and configured.</li>
<li>A Multibuffer has been initialized and set up.</li>
<li>An entry has been added to the buffer, that is, an element has been placed at the end of the Rx Buffer list.</li>
</ol>
<p>Once these steps have been completed, <a class="el" href="_r_c_l_8h.html#a335ebd06e9591a1a9ec26bde80199d96" title="Submit RCL command object to be scheduled for execution. ">RCL_Command_submit</a> and <a class="el" href="_r_c_l_8h.html#adc809f6096147ac6e33641fb2161a859" title="Wait for a submitted command to complete. ">RCL_Command_pend</a> are called to effectively send and then wait for the command to conclude. Once this has happened, the callback and the command status can be used for error checking and the application can proceed according to its specification.</p>
<h1>Usage</h1>
<p>The Generic Rx command is normally employed when the user wants to receive a packet where the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> does not provide a dedicated handler for the communication protocol. In this case, it is up to the application to define how packets are built (for the Tx side) and how they are meant to be received (for the Rx side). All of this while also considering the <a href="rcl_command_handlers.html">internal packet format</a> in which packets are stored in the LRF FIFOs.</p>
<p>Just as with any command, it's necessary to declare it and configure it before submitting it. However, since this is a Rx operation, in addition to performing the command configuration, it is also necessary to set up the Rx buffers to store the packets. Furthermore, the timing information stored in the common command configuration can be used to set graceful stop and hard stop times.</p>
<p>One particularity about the Generic Rx command handler is that if supported on the PHY, it is possible to configure the LRF so that it listens to two different syncwords (known as SyncwordA and SyncwordB).</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define NUM_RX_BUF 1</span></div><div class="line"><span class="preprocessor">#define MULTI_BUF_SZ 1024</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> runGenericRx(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint32_t rxMultiBuffer[NUM_RX_BUF][MULTI_BUF_SZ / 4];</div><div class="line">    List_List multiBuffers = { 0 };</div><div class="line"></div><div class="line">    <span class="comment">/* Set up Rx (multi)buffer */</span></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; NUM_RX_BUF; i++)</div><div class="line">    {</div><div class="line">        RCL_MultiBuffer *multiBuffer = (RCL_MultiBuffer *) rxMultiBuffer[i];</div><div class="line">        <a class="code" href="group__buffer_api_functions.html#ga9557389c0630c4bf6284036587279945">RCL_MultiBuffer_init</a>(multiBuffer, MULTI_BUF_SZ);</div><div class="line">        <a class="code" href="group__buffer_api_functions.html#gaf9be361ce2825a10f9ee8a132f8ad920">RCL_MultiBuffer_put</a>(&amp;multiBuffers, multiBuffer);</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="_r_c_l_8c.html#a0dba4dc6bc994b9f25813b3ed6d975c2">RCL_init</a>();</div><div class="line">    RCL_Handle handle = <a class="code" href="_r_c_l_8c.html#ad250dbda0747820e489d38cdb268ecee">RCL_open</a>(&amp;rclClient, &amp;LRF_configGfsk500Kbps);</div><div class="line"></div><div class="line">    <span class="comment">/* Declare command */</span></div><div class="line">    RCL_CmdGenericRx cmd;</div><div class="line">    cmd = <a class="code" href="commands_2generic_8h.html#a75f4404ffca6c1d26341faf40f8b3235">RCL_CmdGenericRx_DefaultRuntime</a>();</div><div class="line">    RCL_StatsGeneric rxStats;</div><div class="line">    rxStats = <a class="code" href="commands_2generic_8h.html#aae08f1279d5d7c8be47a80ea5b155585">RCL_StatsGeneric_DefaultRuntime</a>();</div><div class="line"></div><div class="line">    <span class="comment">/* Command configuration */</span></div><div class="line">    cmd.common.scheduling = <a class="code" href="_r_c_l___command_8h.html#ade08c929505da062070474163417817da36e4eb855b1a8b435564f5911266a55b">RCL_Schedule_AbsTime</a>;</div><div class="line">    cmd.common.runtime.callback = defaultCallback;</div><div class="line">    cmd.common.runtime.rclCallbackMask.value = <a class="code" href="_r_c_l___event_8h.html#a9e6384116d9e2d84f36990827d6e86f1">RCL_EventLastCmdDone</a>.value | <a class="code" href="_r_c_l___event_8h.html#a27efe993ce19cd501e8aadb7c5fa4aee">RCL_EventRxEntryAvail</a>.value;</div><div class="line">    cmd.rfFrequency = FREQUENCY;</div><div class="line">    cmd.syncWordA = SYNCWORD;</div><div class="line">    cmd.syncWordB = SYNCWORD_B;</div><div class="line">    cmd.config.discardRxPackets = 0;</div><div class="line">    cmd.common.status = <a class="code" href="_r_c_l___command_8h.html#ae591a974abf55ca701cf33c61554e0cda1097a97f59467483fb55c8b471cb3036">RCL_CommandStatus_Idle</a>;</div><div class="line"></div><div class="line">    <span class="comment">/* Listen to syncword A and disable syncword B*/</span></div><div class="line">    cmd.config.disableSyncA = 0;</div><div class="line">    cmd.config.disableSyncB = 1;</div><div class="line"></div><div class="line">    <span class="comment">/* Stats configuration */</span></div><div class="line">    rxStats.config.accumulate = 1;</div><div class="line">    rxStats.nRxNok = 0;</div><div class="line">    rxStats.nRxOk = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* Setup a graceful stop time */</span></div><div class="line">    uint32_t ticksPerByte = <a class="code" href="_r_c_l___scheduler_8h.html#acdfb6b54cdc9e000704111729a8319a7">RCL_SCHEDULER_SYSTIM_US</a>(16);</div><div class="line">    uint32_t startDelay = <a class="code" href="_r_c_l___scheduler_8h.html#acdfb6b54cdc9e000704111729a8319a7">RCL_SCHEDULER_SYSTIM_US</a>(300000);</div><div class="line">    uint32_t endPktDelay = <a class="code" href="_r_c_l___scheduler_8h.html#acdfb6b54cdc9e000704111729a8319a7">RCL_SCHEDULER_SYSTIM_US</a>(150);</div><div class="line">    uint32_t packetOffset = ticksPerByte * 10 + endPktDelay;</div><div class="line">    uint32_t pktInterval = ticksPerByte * cmd.maxPktLen + packetOffset;</div><div class="line">    cmd.common.timing.relGracefulStopTime = startDelay + NUM_PKT * pktInterval;</div><div class="line">    cmd.stats = &amp;rxStats;</div><div class="line"></div><div class="line">    <span class="comment">/* Clear multi buffers before starting the operation */</span></div><div class="line">    RCL_MultiBuffer *multiBuffer = <a class="code" href="group__buffer_api_functions.html#gaf48f36094b2839027feea9b2ed3db023">RCL_MultiBuffer_head</a>(&amp;multiBuffers);</div><div class="line">    <span class="keywordflow">while</span> (multiBuffer != NULL)</div><div class="line">    {</div><div class="line">        <a class="code" href="group__buffer_api_functions.html#gabbbf7364e16aae6951ee7c827de9bf06">RCL_MultiBuffer_clear</a>(multiBuffer);</div><div class="line">        multiBuffer = <a class="code" href="group__buffer_api_functions.html#ga05fa5798eb559b09a069b15bad0de4f1">RCL_MultiBuffer_next</a>(multiBuffer);</div><div class="line">    }</div><div class="line">    cmd.rxBuffers = multiBuffers;</div><div class="line"></div><div class="line">    <span class="comment">/* Configure the green LED pin */</span></div><div class="line">    GPIO_setConfig(CONFIG_GPIO_GLED, GPIO_CFG_OUT_STD | GPIO_CFG_OUT_LOW);</div><div class="line">    GPIO_write(CONFIG_GPIO_GLED, CONFIG_GPIO_LED_OFF);</div><div class="line"></div><div class="line">    <span class="comment">/* Schedule first command considering a start delay of 600 us */</span></div><div class="line">    uint32_t nextTime = <a class="code" href="group__timing_api_functions.html#gadf6e67c88e75cbe44f52b5b93eecdd09">RCL_Scheduler_getCurrentTime</a>() + <a class="code" href="_r_c_l___scheduler_8h.html#acdfb6b54cdc9e000704111729a8319a7">RCL_SCHEDULER_SYSTIM_US</a>(600);</div><div class="line">    cmd.common.timing.absStartTime = nextTime;</div><div class="line"></div><div class="line">    <a class="code" href="_r_c_l_8c.html#a335ebd06e9591a1a9ec26bde80199d96">RCL_Command_submit</a>(handle, &amp;cmd);</div><div class="line">    <span class="comment">/* Wait for command to conclude  */</span></div><div class="line">    <a class="code" href="_r_c_l_8c.html#adc809f6096147ac6e33641fb2161a859">RCL_Command_pend</a>(&amp;cmd);</div><div class="line"></div><div class="line">    <span class="comment">/* Check the packet contents */</span></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; NUM_PKT; i++)</div><div class="line">    {</div><div class="line">        RCL_Buffer_DataEntry *rxPkt = <a class="code" href="group__buffer_api_functions.html#ga34d0923dddc433082c4d673e7331772d">RCL_MultiBuffer_RxEntry_get</a>(&amp;cmd.rxBuffers, NULL);</div><div class="line">        <span class="keywordflow">if</span> (rxPkt != NULL)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Do something with received packet */</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h1>Architecture</h1>
<p>The Generic Rx command handler has a life cycle that depends on several things. For instance, the operation can be configured so that it concludes once a correct or incorrect packet is received. It can also conclude after having received several packets due to a graceful (or hard) stop. The operation can also conclude when the LRF hasn't found a sync after a specific amount of time set by the protocol, or by a graceful (or hard) stop.</p>
<div align="center">
<img src="inline_umlgraph_5.png" />
<div class="caption">
Generic Rx handler state machine</div>
</div>
<table class="doxtable">
<tr>
<th><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> Event (In) </th><th>Description  </th></tr>
<tr>
<td><em>setup</em> </td><td>Setup has been performed </td></tr>
<tr>
<td><em>timerStart</em> </td><td>Timer-based start signalled </td></tr>
<tr>
<td><em>rxBufferUpdate</em></td><td>RX buffer has been updated </td></tr>
</table>
<table class="doxtable">
<tr>
<th><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> Event (Out) </th><th>Description  </th></tr>
<tr>
<td><em>lastCmdDone</em> </td><td>The <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> is finished with the command </td></tr>
<tr>
<td><em>cmdStarted</em> </td><td>Command handler has accepted and started executing </td></tr>
<tr>
<td><em>rxBufferFinished</em> </td><td>An RX multi-buffer is finished </td></tr>
<tr>
<td><em>rxEntryAvail</em> </td><td>An RX entry has been made available </td></tr>
</table>
<table class="doxtable">
<tr>
<th>LRF Event </th><th>Description  </th></tr>
<tr>
<td><em>opDone</em> </td><td>The PBE operation has finished </td></tr>
<tr>
<td><em>opError</em> </td><td>Something went wrong. Cause located in the PBE ENDCAUSE register </td></tr>
<tr>
<td><em>rxOk</em> </td><td>Packet received with CRC OK and not to be ignored by the MCU </td></tr>
<tr>
<td><em>rxNok</em> </td><td>Packet received with CRC error </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="rcl_architecture.html">RCL Architecture</a></li><li class="navelem"><a class="el" href="rcl_command_handlers.html">Command Handlers</a></li><li class="navelem"><a class="el" href="generic_command_handlers.html">Generic Command Handlers</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
