<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Radio Control Layer (RCL): Secondary Channel Advertiser Command Handler</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Radio Control Layer (RCL)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('auxiliary_advertiser_handler.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Secondary Channel Advertiser Command Handler </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Introduction</h1>
<p>The secondary channel advertiser command handler is a "special" handler meant for testing purposes that can be used for starting advertising on a <a href="rcl_glossary.html##secondary-advertising-channel">secondary advertising channel</a>. Unlike the advertiser handler, this command handler <b>only</b> supports <a href="rcl_glossary.html##extended-advertising">extended advertising</a> PDUs which use the <a href="rcl_glossary.html##secondary-advertising-channel">secondary physical channel</a>.</p>
<table class="doxtable">
<tr>
<th align="center">PDU Type </th><th align="center">PDU Name </th><th>Physical Channel </th><th align="center">LE 1M </th><th align="center">LE 2M </th><th align="center">LE Coded </th><th align="center">Currently Supported  </th></tr>
<tr>
<td align="center">0b0111 </td><td align="center">AUX_ADV_IND </td><td>Secondary </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center">* </td></tr>
<tr>
<td align="center">0b0111 </td><td align="center">AUX_SCAN_RSP </td><td>Secondary </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center"></td></tr>
<tr>
<td align="center">0b0111 </td><td align="center">AUX_SYNC_IND </td><td>Periodic </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center"></td></tr>
<tr>
<td align="center">0b0111 </td><td align="center">AUX_CHAIN_IND </td><td>Secondary and Periodic </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center">* </td></tr>
<tr>
<td align="center">0b0111 </td><td align="center">AUX_SYNC_SUBEVENT_IND </td><td>Periodic </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center"></td></tr>
<tr>
<td align="center">0b0111 </td><td align="center">AUX_SYNC_SUBEVENT_RSP </td><td>Periodic </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center"></td></tr>
<tr>
<td align="center">0b1000 </td><td align="center">AUX_CONNECT_RSP </td><td>Secondary </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center"></td></tr>
</table>
<h1>Usage</h1>
<p>How the secondary advertiser command handler is configured and used depends on the type of PDU that is supposed to be sent. Nevertheless, the following basic steps must have taken place before submitting the an advertiser command:</p>
<ol type="1">
<li><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> has been initialized (See <a class="el" href="_r_c_l_8h.html#a0dba4dc6bc994b9f25813b3ed6d975c2" title="Initializes the RCL driver state. ">RCL_init</a>) and a handle must exist (See <a class="el" href="_r_c_l_8h.html#ad250dbda0747820e489d38cdb268ecee" title="Initializes an RCL client instance. ">RCL_open</a>).</li>
<li>The <a class="el" href="commands_2ble5_8h.html#struct_r_c_l___c_m_d___b_l_e5___a_u_x___a_d_v__t" title="Secondary Channel Advertiser command. ">RCL_CMD_BLE5_AUX_ADV_t</a> command has been initialized and configured.</li>
<li>The necessary Tx buffer(s) have been initialized and configured.</li>
<li>If needed, the necessary Multibuffer for reception has been initialized and configured.</li>
</ol>
<p>Once these steps have been completed, <a class="el" href="_r_c_l_8h.html#a335ebd06e9591a1a9ec26bde80199d96" title="Submit RCL command object to be scheduled for execution. ">RCL_Command_submit</a> and <a class="el" href="_r_c_l_8h.html#adc809f6096147ac6e33641fb2161a859" title="Wait for a submitted command to complete. ">RCL_Command_pend</a> are called to effectively send a packet and then wait for the command to conclude. Alternatively, callbacks can be used for post-processing and the submitting of new commands.</p>
<p>Command configuration and submitting is similar to the advertiser command handler, with the exception that the command handler requires the configuration of a channel to start the operation.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> runSecondaryAdvertiser(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="_r_c_l_8c.html#a0dba4dc6bc994b9f25813b3ed6d975c2">RCL_init</a>();</div><div class="line">    RCL_Handle h = <a class="code" href="_r_c_l_8c.html#ad250dbda0747820e489d38cdb268ecee">RCL_open</a>(&amp;rclClient, &amp;LRF_configBle);</div><div class="line"></div><div class="line">    RCL_Buffer_TxBuffer *auxAdvTxBuffer = (RCL_Buffer_TxBuffer *)txBuffer;</div><div class="line"></div><div class="line">    AuxPtr auxAdvAuxPtr;</div><div class="line"></div><div class="line">    auxAdvCmd = <a class="code" href="commands_2ble5_8h.html#af5c77005b0688bc3e8cd3724a1b3714a">RCL_CmdBle5AuxAdvertiser_DefaultRuntime</a>();</div><div class="line">    auxAdvCmd.channel = 25;</div><div class="line">    auxAdvCmd.ctx = &amp;auxAdvCtx;</div><div class="line">    auxAdvCmd.stats = &amp;auxAdvStats;</div><div class="line">    auxAdvCmd.common.scheduling = <a class="code" href="_r_c_l___command_8h.html#ade08c929505da062070474163417817da39c41d2c31edf75e6c226a4613d313cb">RCL_Schedule_Now</a>;</div><div class="line">    auxAdvCmd.common.runtime.callback = advCallback;</div><div class="line">    auxAdvCmd.common.runtime.lrfCallbackMask.value = 0;</div><div class="line">    auxAdvCmd.common.runtime.rclCallbackMask.value = <a class="code" href="_r_c_l___event_8h.html#a9e6384116d9e2d84f36990827d6e86f1">RCL_EventLastCmdDone</a>.value |</div><div class="line">                                                     <a class="code" href="_r_c_l___event_8h.html#a28a8b7bf8fe0f5dda1825764511ead58">RCL_EventTxBufferFinished</a>.value;</div><div class="line">    auxAdvCtx = <a class="code" href="commands_2ble5_8h.html#ae293c8e059fc5df3bb8bedd66e51c05c">RCL_CtxAdvertiser_DefaultRuntime</a>();</div><div class="line">    auxAdvStats = (RCL_StatsAdvScanInit) { 0 };</div><div class="line">    auxAdvStats.config.accumulate = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* AuxPtr to be used for the AUX_ADV_IND indicating that the next auxiliary packet will be sent on:</span></div><div class="line"><span class="comment">     * BLE 2M PHY, channel 5, and in 1.2 [ms].</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    auxAdvAuxPtr.auxOffset = 4;</div><div class="line">    auxAdvAuxPtr.offsetUnits = 1;</div><div class="line">    auxAdvAuxPtr.auxPhy = 1;</div><div class="line">    auxAdvAuxPtr.ca = 0;</div><div class="line">    auxAdvAuxPtr.chIndex = 5;</div><div class="line"></div><div class="line">    <span class="comment">/* Populate Tx buffer used for the AUX_ADV_IND that will be sent on a secondary advertisement channel */</span></div><div class="line">    setAuxAdvBuffer(auxAdvTxBuffer, &amp;auxAdvAuxPtr, AUX_ADV_DATA_LEN);</div><div class="line"></div><div class="line">    auxAdvTxBuffer-&gt;state = <a class="code" href="_r_c_l___buffer_8h.html#ac036c6839eff8b28db4bc8571b059ee7ae722d0ac8d34033b121f79152a41e0cf">RCL_BufferStatePending</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group__buffer_api_functions.html#ga7ef1355f9f5e5afb2e301ab8554b4239">RCL_TxBuffer_put</a>(&amp;auxAdvCtx.txBuffers, auxAdvTxBuffer);</div><div class="line"></div><div class="line">    <a class="code" href="_r_c_l_8c.html#a335ebd06e9591a1a9ec26bde80199d96">RCL_Command_submit</a>(h, &amp;auxAdvCmd);</div><div class="line">    <span class="comment">/* Wait for command to conclude  */</span></div><div class="line">    <a class="code" href="_r_c_l_8c.html#adc809f6096147ac6e33641fb2161a859">RCL_Command_pend</a>(&amp;auxAdvCmd);</div><div class="line"></div><div class="line">    <a class="code" href="_r_c_l_8c.html#a768c2d6b577588b948f1bb02278c66ec">RCL_close</a>(h);</div><div class="line">}</div></div><!-- fragment --><p> Notice how the <a href="rcl_glossary.html##aux-pointer">AuxPtr</a> previously defined are used to populate the Tx Buffer with the help of a C struct.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    uint8_t   chIndex: 6;</div><div class="line">    uint8_t   ca: 1;</div><div class="line">    uint8_t   offsetUnits: 1;</div><div class="line">    uint16_t  auxOffset: 13;</div><div class="line">    uint16_t  auxPhy: 3;</div><div class="line">} AuxPtr;</div></div><!-- fragment --> <h1>Architecture</h1>
<p>The life cycle of the secondary advertiser command handler depends on the type advertising and more specifically the PDU type. The PDU type will determine aspects such as the number of Tx buffers needed for the operation, or whether the operation involves both Tx and Rx, or just Tx. It is the responsibility of the caller to provide a Tx Buffer containing a valid advertising physical channel PDU.</p>
<p>Furthermore, unlike the advertiser command handler, this command handler does not support the possibility to do <a href="rcl_glossary.html##phy-switching">PHY switching</a> as this is meant to be handled during the primary channel advertising.</p>
<p>The following activity diagram illustrates the behavior of the secondary channel advertiser command handler.</p>
<div align="center">
<img src="inline_umlgraph_2.png" />
</div>
<table class="doxtable">
<tr>
<th><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> Event (In) </th><th>Description  </th></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a7e133b0824b82207e63e7aee9d879a00">RCL_EventSetup</a> </td><td>Setup has been performed </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#ac6113be9a78ca3f797cb48abb591dbf0">RCL_EventTimerStart</a> </td><td>Timer-based start signalled </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a7d60d7e5a2858424057b91442bf2c1c2">RCL_EventGracefulStop</a> </td><td>Graceful stop has been observed </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#adcb810ebde7a2953fc3db18c34af0e15">RCL_EventHardStop</a> </td><td>Hard stop has been observed </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a75d9156eee1428eca15dbf839037a5e9">RCL_EventRxBufferUpdate</a> </td><td>RX buffer has been updated </td></tr>
</table>
<table class="doxtable">
<tr>
<th><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> Event (Out) </th><th>Description  </th></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a9e6384116d9e2d84f36990827d6e86f1">RCL_EventLastCmdDone</a> </td><td>The <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> is finished with the command </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a175760e464528c714aeb3755a304ff7a">RCL_EventCmdStarted</a> </td><td>Command handler has accepted and started executing </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#ab30a28e180e11b477202588d6d2e222d">RCL_EventRxBufferFinished</a> </td><td>An RX multi-buffer is finished </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a27efe993ce19cd501e8aadb7c5fa4aee">RCL_EventRxEntryAvail</a> </td><td>An RX entry has been made available </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a28a8b7bf8fe0f5dda1825764511ead58">RCL_EventTxBufferFinished</a> </td><td>An TX buffer is finished </td></tr>
</table>
<table class="doxtable">
<tr>
<th>LRF Event </th><th>Description  </th></tr>
<tr>
<td><a class="el" href="_l_r_f_c_c23_x0_8h.html#a4da8165cef174c2e34178032b799d984">LRF_EventOpDone</a> </td><td>The PBE operation has finished </td></tr>
<tr>
<td><a class="el" href="_l_r_f_c_c23_x0_8h.html#afee97748de710b92c864db03e6707104">LRF_EventOpError</a> </td><td>Something went wrong. Cause located in the PBE ENDCAUSE register </td></tr>
<tr>
<td><a class="el" href="_l_r_f_c_c23_x0_8h.html#a47f68c8084c244a4e11a8749a5ec12d3">LRF_EventRxOk</a> </td><td>Packet received with CRC OK and not to be ignored by the MCU </td></tr>
<tr>
<td><a class="el" href="_l_r_f_c_c23_x0_8h.html#af96c13dce5396989e7c7bc36cd7bd0a1">LRF_EventRxNok</a> </td><td>Packet received with CRC error </td></tr>
<tr>
<td><a class="el" href="_l_r_f_c_c23_x0_8h.html#ae8c5c6252c33d0b7a01ed89fc3986632">LRF_EventRxIgnored</a> </td><td>Packet received, but may be ignored by MCU </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="rcl_architecture.html">RCL Architecture</a></li><li class="navelem"><a class="el" href="rcl_command_handlers.html">Command Handlers</a></li><li class="navelem"><a class="el" href="ble_command_handlers.html">BLE Command Handlers</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
