<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Radio Control Layer (RCL): Advertiser Command Handler</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Radio Control Layer (RCL)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('advertiser_handler.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Advertiser Command Handler </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Introduction</h1>
<p>In <a href="https://www.bluetooth.com/learn-about-bluetooth/tech-overview/">Bluetooth&reg; Low Energy (BLE)</a>, the process of "advertising" is a critical part of the communication protocol, serving as a means for devices to broadcast their presence and capabilities to potential counterparts. Furthermore, with the introduction of <a href="rcl_glossary.html##extended-advertising">extended advertising</a>, the capabilities of traditional or <a href="rcl_glossary.html##legacy-advertising">legacy advertising</a> are augmented offering enhanced features for more extensive communication between BLE devices.</p>
<p>Regardless of whether legacy or extended advertising is used, <a href="rcl_glossary.html##advertising-pdu">advertising PDUs</a> are used as information carriers during the advertising process and the specific type of <a href="rcl_glossary.html##pdu">PDU</a> plays a significant role in the way that the command handler and the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> behave. Therefore, before describing how the advertising command works, it is worth mentioning the different advertising PDUs involved in the command handler's lifecycle.</p>
<table class="doxtable">
<tr>
<th align="center">PDU Type </th><th align="center">PDU Name </th><th>Physical Channel </th><th align="center">LE 1M </th><th align="center">LE 2M </th><th align="center">LE Coded </th><th align="center">Currently Supported  </th></tr>
<tr>
<td align="center">0b0000 </td><td align="center">ADV_IND </td><td>Primary </td><td align="center">* </td><td align="center"></td><td align="center"></td><td align="center">* </td></tr>
<tr>
<td align="center">0b0001 </td><td align="center">ADV_DIRECT_IND </td><td>Primary </td><td align="center">* </td><td align="center"></td><td align="center"></td><td align="center">* </td></tr>
<tr>
<td align="center">0b0010 </td><td align="center">ADV_NONCONN_IND </td><td>Primary </td><td align="center">* </td><td align="center"></td><td align="center"></td><td align="center">* </td></tr>
<tr>
<td align="center">0b0011 </td><td align="center">SCAN_REQ </td><td>Primary </td><td align="center">* </td><td align="center"></td><td align="center"></td><td align="center">* </td></tr>
<tr>
<td align="center">0b0011 </td><td align="center">AUX_SCAN_REQ </td><td>Secondary </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center"></td></tr>
<tr>
<td align="center">0b0100 </td><td align="center">SCAN_RSP </td><td>Primary </td><td align="center">* </td><td align="center"></td><td align="center"></td><td align="center">* </td></tr>
<tr>
<td align="center">0b0101 </td><td align="center">CONNECT_IND </td><td>Primary </td><td align="center">* </td><td align="center"></td><td align="center"></td><td align="center">* </td></tr>
<tr>
<td align="center">0b0101 </td><td align="center">AUX_CONNECT_REQ </td><td>Secondary </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center"></td></tr>
<tr>
<td align="center">0b0110 </td><td align="center">ADV_SCAN_IND </td><td>Primary </td><td align="center">* </td><td align="center"></td><td align="center"></td><td align="center">* </td></tr>
<tr>
<td align="center">0b0111 </td><td align="center">ADV_EXT_IND </td><td>Primary </td><td align="center">* </td><td align="center"></td><td align="center">* </td><td align="center">* </td></tr>
<tr>
<td align="center">0b0111 </td><td align="center">AUX_ADV_IND </td><td>Secondary </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center">* </td></tr>
<tr>
<td align="center">0b0111 </td><td align="center">AUX_SCAN_RSP </td><td>Secondary </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center"></td></tr>
<tr>
<td align="center">0b0111 </td><td align="center">AUX_SYNC_IND </td><td>Periodic </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center"></td></tr>
<tr>
<td align="center">0b0111 </td><td align="center">AUX_CHAIN_IND </td><td>Secondary and Periodic </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center">* </td></tr>
<tr>
<td align="center">0b0111 </td><td align="center">AUX_SYNC_SUBEVENT_IND </td><td>Periodic </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center"></td></tr>
<tr>
<td align="center">0b0111 </td><td align="center">AUX_SYNC_SUBEVENT_RSP </td><td>Periodic </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center"></td></tr>
<tr>
<td align="center">0b1000 </td><td align="center">AUX_CONNECT_RSP </td><td>Secondary </td><td align="center">* </td><td align="center">* </td><td align="center">* </td><td align="center"></td></tr>
</table>
<p>Please note that legacy advertising PDUs are limited to <a href="rcl_glossary.html##primary-advertising-channel">primary advertising channels</a> and have a specific payloads, while extended advertising PDUs share the same PDU payload format known as the <a href="rcl_glossary.html##common-extended-advertising-payload-format">Common Extended Advertising Payload Format</a>.</p>
<p>The advertiser command handler supports both legacy and extended advertising by extracting the PDU type and if needed, the AdvMode associated with the PDU.</p>
<div class="image">
<img src="advertising_physical_channel_pdu.png" alt="advertising_physical_channel_pdu.png"/>
<div class="caption">
Advertising Physical Channel PDU</div></div>
 <h1>Usage</h1>
<p>How the advertiser command handler is configured and used depends on the type of PDU that is supposed to be sent. Nevertheless, the following basic steps must have taken place before submitting the an advertiser command:</p>
<ol type="1">
<li><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> has been initialized (See <a class="el" href="_r_c_l_8h.html#a0dba4dc6bc994b9f25813b3ed6d975c2" title="Initializes the RCL driver state. ">RCL_init</a>) and a handle must exist (See <a class="el" href="_r_c_l_8h.html#ad250dbda0747820e489d38cdb268ecee" title="Initializes an RCL client instance. ">RCL_open</a>).</li>
<li>The <a class="el" href="commands_2ble5_8h.html#struct_r_c_l___c_m_d___b_l_e5___a_d_v__t" title="Advertiser command. ">RCL_CMD_BLE5_ADV_t</a> command has been initialized and configured.</li>
<li>The necessary Tx buffer(s) have been initialized and configured.</li>
<li>If needed, the necessary Multibuffer for reception has been initialized and configured.</li>
</ol>
<p>Once these steps have been completed, <a class="el" href="_r_c_l_8h.html#a335ebd06e9591a1a9ec26bde80199d96" title="Submit RCL command object to be scheduled for execution. ">RCL_Command_submit</a> is called to start the command. Once submitted, the caller can either use <a class="el" href="_r_c_l_8h.html#adc809f6096147ac6e33641fb2161a859" title="Wait for a submitted command to complete. ">RCL_Command_pend</a> or a callback to wait for the command's conclusion and proceed with any additional tasks such as post-processing or the submitting of new commands.</p>
<p>As an example, the following code snippet shows how the advertiser command handler can be used to start an extended advertising event composed by one AXU_ADV_IND PDU and one or more AUX_CHAIN_IND PDUs.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> runExtendedAdvertiser(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="_r_c_l_8c.html#a0dba4dc6bc994b9f25813b3ed6d975c2">RCL_init</a>();</div><div class="line">    RCL_Handle h = <a class="code" href="_r_c_l_8c.html#ad250dbda0747820e489d38cdb268ecee">RCL_open</a>(&amp;rclClient, &amp;LRF_configBle);</div><div class="line"></div><div class="line">    RCL_Buffer_TxBuffer *advExtTxBuffer = (RCL_Buffer_TxBuffer *)txBuffer;</div><div class="line">    RCL_Buffer_TxBuffer *auxAdvTxBuffer = (RCL_Buffer_TxBuffer *)txBuffer2;</div><div class="line"></div><div class="line">    AuxPtr advExtAuxPtr;</div><div class="line">    AuxPtr auxAdvAuxPtr;</div><div class="line"></div><div class="line">    advCmd = <a class="code" href="commands_2ble5_8h.html#a713930140fca7e3a93e6bd68c59001af">RCL_CmdBle5Advertiser_DefaultRuntime</a>();</div><div class="line">    advCmd.ctx = &amp;advCtx;</div><div class="line">    advCmd.stats = &amp;advStats;</div><div class="line">    advCmd.common.scheduling = <a class="code" href="_r_c_l___command_8h.html#ade08c929505da062070474163417817da39c41d2c31edf75e6c226a4613d313cb">RCL_Schedule_Now</a>;</div><div class="line">    advCmd.common.runtime.callback = advCallback;</div><div class="line">    advCmd.common.runtime.lrfCallbackMask.value = 0;</div><div class="line">    advCmd.common.runtime.rclCallbackMask.value = <a class="code" href="_r_c_l___event_8h.html#a9e6384116d9e2d84f36990827d6e86f1">RCL_EventLastCmdDone</a>.value |</div><div class="line">                                                  <a class="code" href="_r_c_l___event_8h.html#a28a8b7bf8fe0f5dda1825764511ead58">RCL_EventTxBufferFinished</a>.value;</div><div class="line">    advCtx = <a class="code" href="commands_2ble5_8h.html#ae293c8e059fc5df3bb8bedd66e51c05c">RCL_CtxAdvertiser_DefaultRuntime</a>();</div><div class="line">    advStats = (RCL_StatsAdvScanInit) { 0 };</div><div class="line">    advStats.config.accumulate = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* AuxPtr to be used for the ADV_EXT_IND indicating that the auxiliary packet (i.e. AUX_ADV_IND) will be sent on:</span></div><div class="line"><span class="comment">     * BLE 2M PHY, channel 25, and as soon as possible.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    advExtAuxPtr.auxOffset = 0;</div><div class="line">    advExtAuxPtr.offsetUnits = 1;</div><div class="line">    advExtAuxPtr.auxPhy = 1;</div><div class="line">    advExtAuxPtr.ca = 0;</div><div class="line">    advExtAuxPtr.chIndex = 25;</div><div class="line"></div><div class="line">    <span class="comment">/* AuxPtr to be used for the AUX_ADV_IND indicating that a chained packet will be sent on:</span></div><div class="line"><span class="comment">     * Channel 16, and as soon as possible. No PHY change allowed at this point.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    auxAdvAuxPtr.auxOffset = 0;</div><div class="line">    auxAdvAuxPtr.offsetUnits = 1;</div><div class="line">    auxAdvAuxPtr.ca = 0;</div><div class="line">    auxAdvAuxPtr.chIndex = 16;</div><div class="line">    auxAdvAuxPtr.auxPhy = 1;</div><div class="line"></div><div class="line">    <span class="comment">/* Populate Tx buffer used for the ADV_EXT_IND that will be sent on all primary advertisement channels */</span></div><div class="line">    setAdvExtBuffer(advExtTxBuffer, &amp;advExtAuxPtr);</div><div class="line"></div><div class="line">    <span class="comment">/* Populate Tx buffer used for the AUX_ADV_IND that will be sent on a secondary advertisement channel */</span></div><div class="line">    setAuxAdvBuffer(auxAdvTxBuffer, &amp;auxAdvAuxPtr, AUX_ADV_DATA_LEN);</div><div class="line"></div><div class="line">    advExtTxBuffer-&gt;state = <a class="code" href="_r_c_l___buffer_8h.html#ac036c6839eff8b28db4bc8571b059ee7ae722d0ac8d34033b121f79152a41e0cf">RCL_BufferStatePending</a>;</div><div class="line">    auxAdvTxBuffer-&gt;state = <a class="code" href="_r_c_l___buffer_8h.html#ac036c6839eff8b28db4bc8571b059ee7ae722d0ac8d34033b121f79152a41e0cf">RCL_BufferStatePending</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group__buffer_api_functions.html#ga7ef1355f9f5e5afb2e301ab8554b4239">RCL_TxBuffer_put</a>(&amp;advCtx.txBuffers, advExtTxBuffer);</div><div class="line">    <a class="code" href="group__buffer_api_functions.html#ga7ef1355f9f5e5afb2e301ab8554b4239">RCL_TxBuffer_put</a>(&amp;advCtx.txBuffers, auxAdvTxBuffer);</div><div class="line"></div><div class="line">    <a class="code" href="_r_c_l_8c.html#a335ebd06e9591a1a9ec26bde80199d96">RCL_Command_submit</a>(h, &amp;advCmd);</div><div class="line">    <span class="comment">/* Wait for command to conclude */</span></div><div class="line">    <a class="code" href="_r_c_l_8c.html#adc809f6096147ac6e33641fb2161a859">RCL_Command_pend</a>(&amp;advCmd);</div><div class="line"></div><div class="line">    <a class="code" href="_r_c_l_8c.html#a768c2d6b577588b948f1bb02278c66ec">RCL_close</a>(h);</div><div class="line">}</div></div><!-- fragment --><p> Configuration of the command is the same regardless of whether the caller wants to use legacy advertising or extended advertising. Nevertheless, it is the job of the caller to provide the appropriate number of Tx buffers with the appropriate structure for the type of advertising.</p>
<p>In legacy advertising, either one or two Tx buffers will be needed, depending on whether a scan response is required by the type of advertising.</p>
<p>In extended advertising, at least two buffers must be present in the Tx buffer list at command start. One of these Tx buffers corresponds to the EXT_ADV_IND PDU sent over the <a href="rcl_glossary.html##primary-advertising-channel">primary advertising channels</a>, while the second Tx Buffer in the list corresponds to the AUX_ADV_IND PDU that indicates the start of the <a href="rcl_glossary.html##auxiliary-advertising-segment">auxiliary advertising segment</a>.</p>
<p>In any case, the command handler will inspect the provided Tx Buffer(s), and based on the type of advertising, it will determine whether it's legacy advertising or extended advertising.</p>
<p>In the previous code snippet Tx buffers are built with helper functions which populate the Tx buffer with appropriate values for each of the fields present in the <a href="rcl_glossary.html##common-extended-advertising-payload-format">Common Extended Advertising Payload Format</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> setAdvExtBuffer(RCL_Buffer_TxBuffer *buffer, AuxPtr *advExtAuxPtr)</div><div class="line">{</div><div class="line">    <span class="comment">/* Include extra octet corresponding to the extended header length and AdvMode */</span></div><div class="line">    uint8_t payloadLength = 1 + ADV_EXT_HDR_LEN;</div><div class="line"></div><div class="line">    uint8_t *txData;</div><div class="line">    txData = <a class="code" href="group__buffer_api_functions.html#ga6fc3e5a4bff33ded64a77ea203128805">RCL_TxBuffer_init</a>(buffer, NUM_PAD, BLE_HDR_LEN, payloadLength);</div><div class="line">    txData[0] = BLE_HDR_ADV_EXT_IND;</div><div class="line">    txData[1] = payloadLength;</div><div class="line">    txData[2] = (<a class="code" href="ble5_8c.html#ad4a9913b8d83da8cf06053c11584cdaa">BLE_ADV_MODE_NONCONN_NONSCAN</a> &lt;&lt; 6) | ADV_EXT_HDR_LEN;</div><div class="line">    txData[3] = BLE5_EXT_HDR_FLAG_ADI_BM | BLE5_EXT_HDR_FLAG_AUX_PTR_BM;</div><div class="line"></div><div class="line">    <span class="comment">/* ADI */</span></div><div class="line">    txData[4] = 0;</div><div class="line">    txData[5] = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* AuxPtr: Channel index, CA, and Offset Units */</span></div><div class="line">    txData[6] = (advExtAuxPtr-&gt;chIndex | (advExtAuxPtr-&gt;ca &lt;&lt; 6) | (advExtAuxPtr-&gt;offsetUnits &lt;&lt; 7));</div><div class="line">    <span class="comment">/* 8 least significant bits of auxOffset */</span></div><div class="line">    txData[7] = advExtAuxPtr-&gt;auxOffset &amp; 0xFF;</div><div class="line">    <span class="comment">/* 5 most significant bits of auxOffset and auxPhy */</span></div><div class="line">    txData[8] = ((advExtAuxPtr-&gt;auxOffset &gt;&gt; 8) &amp; 0x1F) | (advExtAuxPtr-&gt;auxPhy &lt;&lt; 5);</div><div class="line">    <span class="comment">/* ADV_EXT_IND does not contain any advertising data */</span></div><div class="line">}</div></div><!-- fragment --> <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> setAuxAdvBuffer(RCL_Buffer_TxBuffer *buffer, AuxPtr *auxAdvAuxPtr, uint8_t advDataLen)</div><div class="line">{</div><div class="line">    <span class="comment">/* Include extra octet corresponding to the extended header length and AdvMode */</span></div><div class="line">    uint8_t payloadLength = 1 + AUX_ADV_HDR_LEN + advDataLen;</div><div class="line"></div><div class="line">    uint8_t *txData;</div><div class="line">    txData = <a class="code" href="group__buffer_api_functions.html#ga6fc3e5a4bff33ded64a77ea203128805">RCL_TxBuffer_init</a>(buffer, NUM_PAD, BLE_HDR_LEN, payloadLength);</div><div class="line">    txData[0] = BLE_HDR_AUX_ADV_IND;</div><div class="line">    txData[1] = payloadLength;</div><div class="line">    txData[2] = (<a class="code" href="ble5_8c.html#ad4a9913b8d83da8cf06053c11584cdaa">BLE_ADV_MODE_NONCONN_NONSCAN</a> &lt;&lt; 6) | AUX_ADV_HDR_LEN;</div><div class="line">    txData[3] = BLE5_EXT_HDR_FLAG_ADI_BM | BLE5_EXT_HDR_FLAG_AUX_PTR_BM;</div><div class="line"></div><div class="line">    <span class="comment">/* ADI */</span></div><div class="line">    txData[4] = 0;</div><div class="line">    txData[5] = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* AuxPtr: Channel index, CA, and Offset Units */</span></div><div class="line">    txData[6] = (auxAdvAuxPtr-&gt;chIndex | (auxAdvAuxPtr-&gt;ca &lt;&lt; 6) | (auxAdvAuxPtr-&gt;offsetUnits &lt;&lt; 7));</div><div class="line">    <span class="comment">/* 8 least significant bits of auxOffset */</span></div><div class="line">    txData[7] = auxAdvAuxPtr-&gt;auxOffset &amp; 0xFF;</div><div class="line">    <span class="comment">/* 5 most significant bits of auxOffset and auxPhy */</span></div><div class="line">    txData[8] = ((auxAdvAuxPtr-&gt;auxOffset &gt;&gt; 8) &amp; 0x1F) | (auxAdvAuxPtr-&gt;auxPhy &lt;&lt; 5);</div><div class="line"></div><div class="line">    <span class="comment">/* AdvData */</span></div><div class="line">    <span class="keywordflow">if</span> (advDataLen &gt; 0)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">for</span>(uint32_t i = 0; i &lt; advDataLen; i++)</div><div class="line">        {</div><div class="line">            txData[9 + i] = i &amp; 0xFF;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> Notice how the <a href="rcl_glossary.html##aux-pointer">AuxPtr</a> previously defined are used to populate the Tx Buffer with the help of a C struct. Additionally, keep in mind that the extended header length field indicates the size of the extended header field and that it varies depending on the event type (i.e. the fields permitted in the PDU). For this particular example the ADV_EXT_IND corresponds to an event of type "Non-Connectable/Non-Scannable Undirected with Auxiliary Packet", and the AUX_ADV_IND corresponds to an event of type "Non-Connectable/Non-Scannable Undirected".</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    uint8_t   chIndex: 6;</div><div class="line">    uint8_t   ca: 1;</div><div class="line">    uint8_t   offsetUnits: 1;</div><div class="line">    uint16_t  auxOffset: 13;</div><div class="line">    uint16_t  auxPhy: 3;</div><div class="line">} AuxPtr;</div></div><!-- fragment --><p> Furthermore, in the case of extended advertising, the command handler raises an <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> event indicating that a Tx Buffer is finished (see <a class="el" href="_r_c_l___event_8h.html#a28a8b7bf8fe0f5dda1825764511ead58">RCL_EventTxBufferFinished</a>), so that the caller is made aware (through the callback) that it can add additional Tx buffers to the Tx buffer list.</p>
<p>In this particular example, the callback is used to put a Tx buffer corresponding to the first AUX_CHAIN_IND PDU of the extended advertising event.</p>
<p>Finally, it is worth mentioning that depending on the values used in the <a href="rcl_glossary.html##aux-pointer">AuxPtr</a> the command handler will either automatically take care of the AuxPtr calculation for the current packet and submit the next chained packet as soon as possible, or it will simply send the current packet and then finish the operation (meaning that it is up to the caller to schedule a secondary channel advertiser for the next chained packet).</p>
<p>This is accomplished by defining the "invalid" combination of <a href="rcl_glossary.html##aux-pointer-aux-offset">AuxOffset</a> = 0 and <a href="rcl_glossary.html##aux-pointer-offset-units">OffsetUnits</a> = 1. If this invalid combination is used, the command handler will automatically automatically take care of the AuxPtr calculation. Otherwise, the caller must take care of using the correct AuxPtr values and scheduling the next <a href="rcl_glossary.html##auxiliary-advertising-segment">auxiliary advertising segment</a>.</p>
<h1>Architecture</h1>
<p>The life cycle of the advertiser command handler depends on the type of advertising and more specifically the PDU type. The PDU type will determine aspects such as the number of Tx buffers needed for the operation, or whether the operation involves both Tx and Rx, or just Tx. It is the responsibility of the caller to provide a Tx Buffer containing a valid advertising physical channel PDU.</p>
<p>Furthermore, unlike other command handlers, the advertiser command handler supports the possibility to do <a href="rcl_glossary.html##phy-switching">PHY switching</a> (as required by extended advertising). The following activity diagram illustrates the behavior of the advertiser command handler.</p>
<div align="center">
<img src="inline_umlgraph_1.png" />
</div>
<table class="doxtable">
<tr>
<th><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> Event (In) </th><th>Description  </th></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a7e133b0824b82207e63e7aee9d879a00">RCL_EventSetup</a> </td><td>Setup has been performed </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#ac6113be9a78ca3f797cb48abb591dbf0">RCL_EventTimerStart</a> </td><td>Timer-based start signalled </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a4d3945786923bb24cafc3c493a76d761">RCL_EventHandlerCmdUpdate</a> </td><td>PHY switch has been performed </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a7d60d7e5a2858424057b91442bf2c1c2">RCL_EventGracefulStop</a> </td><td>Graceful stop has been observed </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#adcb810ebde7a2953fc3db18c34af0e15">RCL_EventHardStop</a> </td><td>Hard stop has been observed </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a75d9156eee1428eca15dbf839037a5e9">RCL_EventRxBufferUpdate</a> </td><td>RX buffer has been updated </td></tr>
</table>
<table class="doxtable">
<tr>
<th><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> Event (Out) </th><th>Description  </th></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a9e6384116d9e2d84f36990827d6e86f1">RCL_EventLastCmdDone</a> </td><td>The <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> is finished with the command </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a175760e464528c714aeb3755a304ff7a">RCL_EventCmdStarted</a> </td><td>Command handler has accepted and started executing </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#ab30a28e180e11b477202588d6d2e222d">RCL_EventRxBufferFinished</a> </td><td>An RX multi-buffer is finished </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a27efe993ce19cd501e8aadb7c5fa4aee">RCL_EventRxEntryAvail</a> </td><td>An RX entry has been made available </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a28a8b7bf8fe0f5dda1825764511ead58">RCL_EventTxBufferFinished</a> </td><td>An TX buffer is finished </td></tr>
<tr>
<td><a class="el" href="_r_c_l___event_8h.html#a403a5051998b98b79d14504dc12d8bdf">RCL_EventPartialSetup</a> </td><td>Partial setup is required by handler to perform a PHY switch </td></tr>
</table>
<table class="doxtable">
<tr>
<th>LRF Event </th><th>Description  </th></tr>
<tr>
<td><a class="el" href="_l_r_f_c_c23_x0_8h.html#a4da8165cef174c2e34178032b799d984">LRF_EventOpDone</a> </td><td>The PBE operation has finished </td></tr>
<tr>
<td><a class="el" href="_l_r_f_c_c23_x0_8h.html#afee97748de710b92c864db03e6707104">LRF_EventOpError</a> </td><td>Something went wrong. Cause located in the PBE ENDCAUSE register </td></tr>
<tr>
<td><a class="el" href="_l_r_f_c_c23_x0_8h.html#a47f68c8084c244a4e11a8749a5ec12d3">LRF_EventRxOk</a> </td><td>Packet received with CRC OK and not to be ignored by the MCU </td></tr>
<tr>
<td><a class="el" href="_l_r_f_c_c23_x0_8h.html#af96c13dce5396989e7c7bc36cd7bd0a1">LRF_EventRxNok</a> </td><td>Packet received with CRC error </td></tr>
<tr>
<td><a class="el" href="_l_r_f_c_c23_x0_8h.html#ae8c5c6252c33d0b7a01ed89fc3986632">LRF_EventRxIgnored</a> </td><td>Packet received, but may be ignored by MCU </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="rcl_architecture.html">RCL Architecture</a></li><li class="navelem"><a class="el" href="rcl_command_handlers.html">Command Handlers</a></li><li class="navelem"><a class="el" href="ble_command_handlers.html">BLE Command Handlers</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
