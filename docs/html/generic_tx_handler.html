<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Radio Control Layer (RCL): Generic Tx Command Handler</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Radio Control Layer (RCL)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('generic_tx_handler.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Generic Tx Command Handler </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Introduction</h1>
<p>The generic Tx command allows to transmit a packet at a specific RF frequency and with a specific syncword. The following sections describe how the command can be configured and used, its life cycle, and how it fits into the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> architecture.</p>
<p>In order to submit a Generic Tx command, the following steps must have taken place:</p>
<ol type="1">
<li><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> has been initialized (See <a class="el" href="_r_c_l_8h.html#a0dba4dc6bc994b9f25813b3ed6d975c2" title="Initializes the RCL driver state. ">RCL_init</a>) and a handle must exist (See <a class="el" href="_r_c_l_8h.html#ad250dbda0747820e489d38cdb268ecee" title="Initializes an RCL client instance. ">RCL_open</a>).</li>
<li>The <a class="el" href="commands_2generic_8h.html#struct_r_c_l___c_m_d___g_e_n_e_r_i_c___t_x__t" title="Generic transmit command. ">RCL_CMD_GENERIC_TX_t</a> command has been initialized and configured.</li>
<li>A Tx buffer has been initialized.</li>
<li>An entry has been added to the buffer, that is, an element has been placed at the end of the Tx Buffer list.</li>
</ol>
<p>Once these steps have been completed, <a class="el" href="_r_c_l_8h.html#a335ebd06e9591a1a9ec26bde80199d96" title="Submit RCL command object to be scheduled for execution. ">RCL_Command_submit</a> and <a class="el" href="_r_c_l_8h.html#adc809f6096147ac6e33641fb2161a859" title="Wait for a submitted command to complete. ">RCL_Command_pend</a> are called to effectively send and then wait for the command to conclude. Once this has happened, the callback and the command status can be used for error checking and the application can proceed according to its specification.</p>
<h1>Usage</h1>
<p>The Generic Tx command is normally employed when the user wants to transmit a packet for which the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> does not provide a dedicated handler for the communication protocol. In this case, it is up to the application to define how packets are built considering the internal packet format used to store packets in the LRF FIFOs.</p>
<p>This can be accomplished by using a struct to define the various fields that need to be considered when building the packet.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PKT_LEN 200</span></div><div class="line"><span class="preprocessor">#define HDR_LEN 3</span></div><div class="line"><span class="preprocessor">#define NUM_PKT 4</span></div><div class="line"><span class="preprocessor">#define NUM_PAD 3</span></div><div class="line"><span class="preprocessor">#define FREQUENCY 2470000000</span></div><div class="line"><span class="preprocessor">#define SYNCWORD 0xAB0B51DE</span></div><div class="line"><span class="preprocessor">#define SYNCWORD_B 0xCC0781BA</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define EXAMPLE_HDR 0x00051AA</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define FSK_hdrDef_Default()    \</span></div><div class="line"><span class="preprocessor">{                               \</span></div><div class="line"><span class="preprocessor">    .numHdrBits =  8,           \</span></div><div class="line"><span class="preprocessor">    .numLenBits = 8,            \</span></div><div class="line"><span class="preprocessor">    .lenPos = 0,                \</span></div><div class="line"><span class="preprocessor">    .lenOffset = 0,             \</span></div><div class="line"><span class="preprocessor">    .numPad = 3,                \</span></div><div class="line"><span class="preprocessor">}</span></div><div class="line"><span class="preprocessor">#define FSK_hdrDef_DefaultRuntime() (ExampleRCL_GenericHdrDef) FSK_hdrDef_Default()</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    uint8_t numHdrBits;</div><div class="line">    uint8_t numLenBits;</div><div class="line">    uint8_t lenPos;</div><div class="line">    int8_t lenOffset;</div><div class="line">    uint8_t numPad;</div><div class="line">} ExampleRCL_GenericHdrDef;</div></div><!-- fragment --><p> Just as with any command, it's necessary to declare it and configure it before submitting it. However, since this is a Tx operation, in addition to performing the command configuration, it is also necessary to set up the Tx buffers and build the packets.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> runGenericTx(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ExampleRCL_GenericHdrDef hdrDef = FSK_hdrDef_DefaultRuntime();</div><div class="line"></div><div class="line">    <span class="comment">/* Set up Tx buffers considering 4 packets, packet length of 200 bytes, 2 header bytes and 3 padding bytes */</span></div><div class="line">    RCL_Buffer_TxBuffer *txBuffers[NUM_PKT];</div><div class="line">    uint32_t pktBuffer[NUM_PKT][<a class="code" href="group__buffer_api_functions.html#gade3c0fd0ae25d389875981dac43d5f15">RCL_TxBuffer_len_u32</a>(NUM_PAD, HDR_LEN, PKT_LEN)];</div><div class="line"></div><div class="line">    <a class="code" href="_r_c_l_8c.html#a0dba4dc6bc994b9f25813b3ed6d975c2">RCL_init</a>();</div><div class="line">    RCL_Handle h = <a class="code" href="_r_c_l_8c.html#ad250dbda0747820e489d38cdb268ecee">RCL_open</a>(&amp;rclClient, &amp;LRF_configGfsk500Kbps);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; NUM_PKT; i++)</div><div class="line">    {</div><div class="line">        txBuffers[i] = (RCL_Buffer_TxBuffer *)pktBuffer[i];</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Declare command */</span></div><div class="line">    RCL_CmdGenericTx cmd;</div><div class="line">    cmd = <a class="code" href="commands_2generic_8h.html#a8175ac610dee3e06b3b2b940a6c3ae32">RCL_CmdGenericTx_DefaultRuntime</a>();</div><div class="line"></div><div class="line">    <span class="comment">/* Command configuration */</span></div><div class="line">    cmd.common.scheduling = <a class="code" href="_r_c_l___command_8h.html#ade08c929505da062070474163417817da36e4eb855b1a8b435564f5911266a55b">RCL_Schedule_AbsTime</a>;</div><div class="line">    cmd.common.runtime.callback = defaultCallback;</div><div class="line">    cmd.common.runtime.rclCallbackMask = <a class="code" href="_r_c_l___event_8h.html#a9e6384116d9e2d84f36990827d6e86f1">RCL_EventLastCmdDone</a>;</div><div class="line">    cmd.rfFrequency = FREQUENCY;</div><div class="line">    cmd.syncWord = SYNCWORD;</div><div class="line"></div><div class="line">    generatePackets(txBuffers, NUM_PKT, PKT_LEN, &amp;hdrDef, EXAMPLE_HDR);</div><div class="line">    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; NUM_PKT; i++)</div><div class="line">    {</div><div class="line">        <a class="code" href="group__buffer_api_functions.html#ga7ef1355f9f5e5afb2e301ab8554b4239">RCL_TxBuffer_put</a>(&amp;cmd.txBuffers, txBuffers[i]);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Schedule first command considering a start delay of 600 us */</span></div><div class="line">    uint32_t nextTime = <a class="code" href="group__timing_api_functions.html#gadf6e67c88e75cbe44f52b5b93eecdd09">RCL_Scheduler_getCurrentTime</a>() + <a class="code" href="_r_c_l___scheduler_8h.html#acdfb6b54cdc9e000704111729a8319a7">RCL_SCHEDULER_SYSTIM_US</a>(600);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; NUM_PKT; i++)</div><div class="line">    {</div><div class="line">        cmd.common.status = <a class="code" href="_r_c_l___command_8h.html#ae591a974abf55ca701cf33c61554e0cda1097a97f59467483fb55c8b471cb3036">RCL_CommandStatus_Idle</a>;</div><div class="line">        cmd.common.timing.absStartTime = nextTime;</div><div class="line"></div><div class="line">        <a class="code" href="_r_c_l_8c.html#a335ebd06e9591a1a9ec26bde80199d96">RCL_Command_submit</a>(h, &amp;cmd);</div><div class="line">        <span class="comment">/* Wait for command to conclude  */</span></div><div class="line">        <a class="code" href="_r_c_l_8c.html#adc809f6096147ac6e33641fb2161a859">RCL_Command_pend</a>(&amp;cmd);</div><div class="line"></div><div class="line">        <span class="comment">/* Schedule next command considering the same start delay */</span></div><div class="line">        nextTime = <a class="code" href="group__timing_api_functions.html#gadf6e67c88e75cbe44f52b5b93eecdd09">RCL_Scheduler_getCurrentTime</a>() + <a class="code" href="_r_c_l___scheduler_8h.html#acdfb6b54cdc9e000704111729a8319a7">RCL_SCHEDULER_SYSTIM_US</a>(600);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> The following function serves as an example of how packets can be generated so that they are compatible with the internal packet format of the LRF.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> generatePackets(RCL_Buffer_TxBuffer **txBuffers, uint32_t numPkt, uint32_t pktLen,</div><div class="line">                     ExampleRCL_GenericHdrDef *hdrDef, uint32_t exampleHeader)</div><div class="line">{</div><div class="line">    <span class="keyword">union</span></div><div class="line">    {</div><div class="line">        uint32_t value;</div><div class="line">        uint8_t bytes[4];</div><div class="line">    } header;</div><div class="line"></div><div class="line">    uint8_t hdrLen = (hdrDef-&gt;numHdrBits + 7) / 8;</div><div class="line">    header.value = exampleHeader;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numPkt; i++)</div><div class="line">    {</div><div class="line">        uint8_t *txData;</div><div class="line"></div><div class="line">        <span class="comment">/* Initialize Tx Buffer */</span></div><div class="line">        txData = <a class="code" href="group__buffer_api_functions.html#ga6fc3e5a4bff33ded64a77ea203128805">RCL_TxBuffer_init</a>(txBuffers[i], hdrDef-&gt;numPad, hdrLen, pktLen);</div><div class="line"></div><div class="line">        <span class="comment">/* Insert length field at the specified position in the header */</span></div><div class="line">        <span class="keywordflow">if</span> (hdrDef-&gt;numLenBits &gt; 0)</div><div class="line">        {</div><div class="line">            header.value &amp;= ~(((1 &lt;&lt; hdrDef-&gt;numLenBits) - 1) &lt;&lt; hdrDef-&gt;lenPos);</div><div class="line">            header.value |= (pktLen - hdrDef-&gt;lenOffset) &lt;&lt; hdrDef-&gt;lenPos;</div><div class="line">        }</div><div class="line">        <span class="comment">/* Write header to buffer */</span></div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; hdrLen; i++)</div><div class="line">        {</div><div class="line">            txData[i] = header.bytes[i];</div><div class="line">        }</div><div class="line">        <span class="comment">/* Write the payload */</span></div><div class="line">        <span class="keywordflow">if</span>(pktLen &gt; 0)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">for</span>(uint32_t i = 0; i &lt; pktLen; i++)</div><div class="line">            {</div><div class="line">                txData[hdrLen + i] = i &amp; 0xFF;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> <h1>Architecture</h1>
<p>The Generic Tx command handler life cycle is relatively simple in that mostly depends on the packet being sent. Unlike the Generic Rx command handler, the operation itself is not bound by a timeout, and once the packet is sent and an LRF event is received, the command will end.</p>
<div align="center">
<img src="inline_umlgraph_6.png" />
<div class="caption">
Generic Tx handler state machine</div>
</div>
<table class="doxtable">
<tr>
<th><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> Event (In) </th><th>Description  </th></tr>
<tr>
<td><em>setup</em> </td><td>Setup has been performed </td></tr>
<tr>
<td><em>timerStart</em> </td><td>Timer-based start signalled </td></tr>
</table>
<table class="doxtable">
<tr>
<th><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> Event (Out) </th><th>Description  </th></tr>
<tr>
<td><em>lastCmdDone</em> </td><td>The <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> is finished with the command </td></tr>
<tr>
<td><em>cmdStarted</em> </td><td>Command handler has accepted and started executing </td></tr>
</table>
<table class="doxtable">
<tr>
<th>LRF Event </th><th>Description  </th></tr>
<tr>
<td><em>opDone</em> </td><td>The PBE operation has finished </td></tr>
<tr>
<td><em>opError</em> </td><td>Something went wrong. Cause located in the PBE ENDCAUSE register </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="rcl_architecture.html">RCL Architecture</a></li><li class="navelem"><a class="el" href="rcl_command_handlers.html">Command Handlers</a></li><li class="navelem"><a class="el" href="generic_command_handlers.html">Generic Command Handlers</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
