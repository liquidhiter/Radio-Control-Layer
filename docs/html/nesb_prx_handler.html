<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Radio Control Layer (RCL): NESB PRX Command Handler</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Radio Control Layer (RCL)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('nesb_prx_handler.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">NESB PRX Command Handler </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Introduction</h1>
<p>A PRX device normally acts as the main receiver in an NESB network. Depending on user configuration, the handler acts similarly to the Generic Rx Command handler, or it can add automatic acknowledgement and address filtering.</p>
<p>The following sections describe how the command can be configured and used, its life cycle, and how it fits into the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> architecture.</p>
<h1>Usage</h1>
<p>In order to submit a PRX command, the following steps must have taken place:</p>
<ol type="1">
<li><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> has been initialized (See <a class="el" href="_r_c_l_8h.html#a0dba4dc6bc994b9f25813b3ed6d975c2" title="Initializes the RCL driver state. ">RCL_init</a>) and a handle must exist (See <a class="el" href="_r_c_l_8h.html#ad250dbda0747820e489d38cdb268ecee" title="Initializes an RCL client instance. ">RCL_open</a>).</li>
<li>The <a class="el" href="commands_2generic_8h.html#struct_r_c_l___c_m_d___n_e_s_b___p_r_x__t" title="NESB receive command. ">RCL_CMD_NESB_PRX_t</a> command has been initialized and configured.</li>
<li>A Multibuffer has been set up to receive the incoming packets.</li>
</ol>
<p>Once these steps have been completed, <a class="el" href="_r_c_l_8h.html#a335ebd06e9591a1a9ec26bde80199d96" title="Submit RCL command object to be scheduled for execution. ">RCL_Command_submit</a> and <a class="el" href="_r_c_l_8h.html#adc809f6096147ac6e33641fb2161a859" title="Wait for a submitted command to complete. ">RCL_Command_pend</a> are called to effectively begin the RX operation, and then wait for the command to conclude.</p>
<p>Command configuration and submitting is similar to generic command handlers, but depending on the desired auto acknowledgment behavior, it might be necessary to also configure the sycnword specific behavior.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define NUM_RX_BUF 1</span></div><div class="line"><span class="preprocessor">#define MULTI_BUF_SZ 1024</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> runNesbPrx(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint32_t rxMultiBuffer[NUM_RX_BUF][MULTI_BUF_SZ / 4];</div><div class="line">    List_List multiBuffers = { 0 };</div><div class="line"></div><div class="line">    <a class="code" href="_r_c_l_8c.html#a0dba4dc6bc994b9f25813b3ed6d975c2">RCL_init</a>();</div><div class="line">    RCL_Handle h = <a class="code" href="_r_c_l_8c.html#ad250dbda0747820e489d38cdb268ecee">RCL_open</a>(&amp;rclClient, &amp;LRF_configNesb);</div><div class="line"></div><div class="line">    <span class="comment">/* Declare command */</span></div><div class="line">    RCL_CmdNesbPrx cmd;</div><div class="line">    cmd = <a class="code" href="commands_2generic_8h.html#aa3f20f7a02b6bb444a48846c8a322cd3">RCL_CmdNesbPrx_DefaultRuntime</a>();</div><div class="line">    RCL_StatsNesb rxStats;</div><div class="line">    rxStats = <a class="code" href="commands_2generic_8h.html#a10b0c9e2e88c99a8b03e3ac82df0445e">RCL_StatsNesb_DefaultRuntime</a>();</div><div class="line"></div><div class="line">    <span class="comment">/* Command configuration */</span></div><div class="line">    cmd.common.scheduling = <a class="code" href="_r_c_l___command_8h.html#ade08c929505da062070474163417817da36e4eb855b1a8b435564f5911266a55b">RCL_Schedule_AbsTime</a>;</div><div class="line">    cmd.common.runtime.callback = defaultCallback;</div><div class="line">    cmd.common.runtime.rclCallbackMask.value = <a class="code" href="_r_c_l___event_8h.html#a9e6384116d9e2d84f36990827d6e86f1">RCL_EventLastCmdDone</a>.value | <a class="code" href="_r_c_l___event_8h.html#a27efe993ce19cd501e8aadb7c5fa4aee">RCL_EventRxEntryAvail</a>.value;</div><div class="line">    cmd.rfFrequency = FREQUENCY;</div><div class="line">    cmd.syncWordA = SYNCWORD;</div><div class="line">    cmd.syncWord[0].address = NESB_ADDR; <span class="comment">// Set NESB address</span></div><div class="line">    cmd.addrLen = 4; <span class="comment">// Consider 4 bytes for the NESB address</span></div><div class="line">    cmd.syncWord[0].seqValid = 1; <span class="comment">// Only accept packets with sequence number and CRC different from the previous one</span></div><div class="line">    cmd.syncWord[0].autoAckMode = 3; <span class="comment">// Enable auto-acknowledgement regardless of received NO_ACK.</span></div><div class="line"></div><div class="line">    <span class="comment">/* Stats configuration */</span></div><div class="line">    rxStats.config.accumulate = 1;</div><div class="line">    rxStats.nTx = 0;</div><div class="line">    rxStats.nRxOk = 0;</div><div class="line">    rxStats.nRxNok = 0;</div><div class="line">    rxStats.nRxIgnored = 0;</div><div class="line">    rxStats.nRxAddrMismatch = 0;</div><div class="line">    rxStats.nRxBufFull = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* Set up Rx (multi)buffer */</span></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; NUM_RX_BUF; i++)</div><div class="line">    {</div><div class="line">        RCL_MultiBuffer *multiBuffer = (RCL_MultiBuffer *) rxMultiBuffer[i];</div><div class="line">        <a class="code" href="group__buffer_api_functions.html#ga9557389c0630c4bf6284036587279945">RCL_MultiBuffer_init</a>(multiBuffer, MULTI_BUF_SZ);</div><div class="line">        <a class="code" href="group__buffer_api_functions.html#gaf9be361ce2825a10f9ee8a132f8ad920">RCL_MultiBuffer_put</a>(&amp;multiBuffers, multiBuffer);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Setup a graceful stop time */</span></div><div class="line">    uint32_t ticksPerByte = <a class="code" href="_r_c_l___scheduler_8h.html#acdfb6b54cdc9e000704111729a8319a7">RCL_SCHEDULER_SYSTIM_US</a>(8);</div><div class="line">    uint32_t startDelay = <a class="code" href="_r_c_l___scheduler_8h.html#acdfb6b54cdc9e000704111729a8319a7">RCL_SCHEDULER_SYSTIM_US</a>(6000000);</div><div class="line">    uint32_t endPktDelay = <a class="code" href="_r_c_l___scheduler_8h.html#acdfb6b54cdc9e000704111729a8319a7">RCL_SCHEDULER_SYSTIM_US</a>(150);</div><div class="line">    uint32_t packetOffset = ticksPerByte * 10 + endPktDelay;</div><div class="line">    uint32_t pktInterval = ticksPerByte * cmd.syncWord[0].maxPktLen + packetOffset;</div><div class="line">    cmd.common.timing.relGracefulStopTime = startDelay + NUM_PKT * pktInterval;</div><div class="line">    cmd.stats = &amp;rxStats;</div><div class="line"></div><div class="line">    <span class="comment">/* Clear multi buffers before starting */</span></div><div class="line">    RCL_MultiBuffer *multiBuffer = <a class="code" href="group__buffer_api_functions.html#gaf48f36094b2839027feea9b2ed3db023">RCL_MultiBuffer_head</a>(&amp;multiBuffers);</div><div class="line">    <span class="keywordflow">while</span> (multiBuffer != NULL)</div><div class="line">    {</div><div class="line">        <a class="code" href="group__buffer_api_functions.html#gabbbf7364e16aae6951ee7c827de9bf06">RCL_MultiBuffer_clear</a>(multiBuffer);</div><div class="line">        multiBuffer = <a class="code" href="group__buffer_api_functions.html#ga05fa5798eb559b09a069b15bad0de4f1">RCL_MultiBuffer_next</a>(multiBuffer);</div><div class="line">    }</div><div class="line">    cmd.rxBuffers = multiBuffers;</div><div class="line"></div><div class="line">    <span class="comment">/* Configure the green LED pin */</span></div><div class="line">    GPIO_setConfig(CONFIG_GPIO_GLED, GPIO_CFG_OUT_STD | GPIO_CFG_OUT_LOW);</div><div class="line">    GPIO_write(CONFIG_GPIO_GLED, CONFIG_GPIO_LED_OFF);</div><div class="line"></div><div class="line">    <span class="comment">/* Schedule command considering a start delay of 600 us */</span></div><div class="line">    uint32_t nextTime = <a class="code" href="group__timing_api_functions.html#gadf6e67c88e75cbe44f52b5b93eecdd09">RCL_Scheduler_getCurrentTime</a>() + <a class="code" href="_r_c_l___scheduler_8h.html#acdfb6b54cdc9e000704111729a8319a7">RCL_SCHEDULER_SYSTIM_US</a>(600);</div><div class="line">    cmd.common.timing.absStartTime = nextTime;</div><div class="line"></div><div class="line">    <a class="code" href="_r_c_l_8c.html#a335ebd06e9591a1a9ec26bde80199d96">RCL_Command_submit</a>(h, &amp;cmd);</div><div class="line">    <span class="comment">/* Wait for command to conclude  */</span></div><div class="line">    <a class="code" href="_r_c_l_8c.html#adc809f6096147ac6e33641fb2161a859">RCL_Command_pend</a>(&amp;cmd);</div><div class="line"></div><div class="line">    <span class="comment">/* Check the packet contents */</span></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; NUM_PKT; i++)</div><div class="line">    {</div><div class="line">        RCL_Buffer_DataEntry *rxPkt = <a class="code" href="group__buffer_api_functions.html#ga34d0923dddc433082c4d673e7331772d">RCL_MultiBuffer_RxEntry_get</a>(&amp;cmd.rxBuffers, NULL);</div><div class="line">        <span class="keywordflow">if</span> (rxPkt != NULL)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Do something with the received packet */</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h1>Architecture</h1>
<p>The NESB Prx command handler has a life cycle that depends on several things. If configuration is such that an acknowledgement is expected, the device will automatically switch from Rx mode to Tx mode to send an acknowledge to the specific PTX device that started the packet transaction. Furthermore, the PRX device performs address filtering so that it can ignore packets coming from PTX devices not associated with the network. If a valid packet from a valid address is received, the command can either continue listening for additional packets until a graceful or hard stop ends the operation. Once this has happened, the callback and the command status can be used for error checking and the application can proceed according to its specification.</p>
<div align="center">
<img src="inline_umlgraph_11.png" />
<div class="caption">
NESB PRX handler state machine</div>
</div>
<table class="doxtable">
<tr>
<th><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> Event (In) </th><th>Description  </th></tr>
<tr>
<td><em>setup</em> </td><td>Setup has been performed </td></tr>
<tr>
<td><em>timerStart</em> </td><td>Timer-based start signalled </td></tr>
<tr>
<td><em>rxBufferUpdate</em></td><td>RX buffer has been updated </td></tr>
</table>
<table class="doxtable">
<tr>
<th><a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> Event (Out) </th><th>Description  </th></tr>
<tr>
<td><em>lastCmdDone</em> </td><td>The <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> is finished with the command </td></tr>
<tr>
<td><em>cmdStarted</em> </td><td>Command handler has accepted and started executing </td></tr>
<tr>
<td><em>rxBufferFinished</em> </td><td>An RX multi-buffer is finished </td></tr>
<tr>
<td><em>rxEntryAvail</em> </td><td>An RX entry has been made available </td></tr>
</table>
<table class="doxtable">
<tr>
<th>LRF Event </th><th>Description  </th></tr>
<tr>
<td><em>opDone</em> </td><td>The PBE operation has finished </td></tr>
<tr>
<td><em>opError</em> </td><td>Something went wrong. Cause located in the PBE ENDCAUSE register </td></tr>
<tr>
<td><em>rxOk</em> </td><td>Packet received with CRC OK and not to be ignored by the MCU </td></tr>
<tr>
<td><em>rxNok</em> </td><td>Packet received with CRC error </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="rcl_architecture.html">RCL Architecture</a></li><li class="navelem"><a class="el" href="rcl_command_handlers.html">Command Handlers</a></li><li class="navelem"><a class="el" href="nesb_command_handlers.html">NESB Command Handlers</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
