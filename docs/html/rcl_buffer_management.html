<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Radio Control Layer (RCL): Buffer Management</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Radio Control Layer (RCL)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('rcl_buffer_management.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Buffer Management </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> component includes some APIs to deal with the radio buffers. There are two types of radio buffers:</p>
<ul>
<li>Transmit buffers encapsulate a single frame (payload). This is because when transmitting, it is already known how much data needs to be transferred.</li>
</ul>
<div class="image">
<img src="tx_buffer_org.png" alt="tx_buffer_org.png" width="600"/>
</div>
<ul>
<li>Receive buffers can contain zero or more received frames. This is because when receiving, it is not known how much data will be received.</li>
</ul>
<div class="image">
<img src="rx_buffer_org.png" alt="rx_buffer_org.png" width="800"/>
</div>
<p>Independently from the buffer type, the radio buffers need to follow a specific format so that the LRF can take a particular action depending on the PHY header.</p>
<h1>Usage</h1>
<h2>Transmit buffers</h2>
<p>The following steps are necessary to properly use a Tx buffer:</p>
<ul>
<li>Allocate memory for the Tx buffer entry considering all necessary fields and padding. This can be accomplished by first declaring an array, and using the <a class="el" href="group__buffer_api_functions.html#gade3c0fd0ae25d389875981dac43d5f15" title="Total length of a TX buffer in 32-bit words, including all fields and padding. ">RCL_TxBuffer_len_u32</a> helper to determine the total length of the Tx Buffer in 32-bit words. And second, declaring a pointer of type RCL_Buffer_TxBuffer and making it point to the memory location of the previously created array.</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#define NUM_PKT 4</span></div><div class="line"></div><div class="line">uint32_t pktBuffer[NUM_PKT][<a class="code" href="group__buffer_api_functions.html#gade3c0fd0ae25d389875981dac43d5f15">RCL_TxBuffer_len_u32</a>(NUM_PAD, HDR_LEN, MAX_PKT_LEN)];</div><div class="line">RCL_Buffer_TxBuffer *txBuffers[NUM_PKT];</div><div class="line"></div><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; NUM_PKT; i++)</div><div class="line">{</div><div class="line">    txBuffers[i] = (RCL_Buffer_TxBuffer *)vars.pktBuffer[i];</div><div class="line">}</div></div><!-- fragment --><ul>
<li>Initialize a Tx buffer entry with the correct header, payload and padding lengths. This is needed so that the Tx buffer entry is compatible with the <a href="rcl_command_handlers.html">internal packet format</a> used by the LRF.<ul>
<li>Declare a pointer that will be used to store the address where the first header byte of the entry should be stored.</li>
<li>Initialize the buffer entry</li>
<li>Insert payload, header and length fields.</li>
</ul>
</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; NUM_PKT; i++)</div><div class="line">{</div><div class="line">    uint8_t *txData;</div><div class="line">    txData = <a class="code" href="group__buffer_api_functions.html#ga6fc3e5a4bff33ded64a77ea203128805">RCL_TxBuffer_init</a>(txBuffers[i], NUM_PAD, HDR_LEN, pktLen);</div><div class="line">}</div></div><!-- fragment --><ul>
<li>Place the Tx buffer entry in the linked list of packets to transmit.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; NUM_PKT; i++)</div><div class="line">{</div><div class="line">    <a class="code" href="group__buffer_api_functions.html#ga7ef1355f9f5e5afb2e301ab8554b4239">RCL_TxBuffer_put</a>(&amp;txCmd-&gt;txBuffers, txBuffers[i]);</div><div class="line">}</div></div><!-- fragment --><h2>Receive buffers</h2>
<p>The following steps are necessary to properly use a MultiBuffer for Rx operations:</p>
<ul>
<li>Allocate memory for the MultiBuffer entry. This can be accomplished by first declaring an array, then declaring the structure that holds the linked list that will be used by the LRF for the reception of packets. Finally, a pointer of type RCL_MultiBuffer should be declared and it should point to previously declared MultiBuffer array.</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#define MULTI_BUF_SZ 2048</span></div><div class="line"></div><div class="line">uint32_t multiBufferArray[MULTI_BUF_SZ / 4];</div><div class="line">List_List multiBuffers = { 0 };</div><div class="line">RCL_MultiBuffer *multiBuffer;</div><div class="line">RCL_MultiBuffer *multiBuffer = (RCL_MultiBuffer *) multiBufferArray;</div></div><!-- fragment --><ul>
<li>Initialize a MultiBuffer entry so that it can be provided to the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> for storing received packets.</li>
</ul>
<div class="fragment"><div class="line"><a class="code" href="group__buffer_api_functions.html#ga9557389c0630c4bf6284036587279945">RCL_MultiBuffer_init</a>(multiBuffer, MULTI_BUF_SZ);</div></div><!-- fragment --><ul>
<li>Place the MultiBuffer entry in the linked list used by the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> for packet reception.</li>
</ul>
<div class="fragment"><div class="line"><a class="code" href="group__buffer_api_functions.html#gaf9be361ce2825a10f9ee8a132f8ad920">RCL_MultiBuffer_put</a>(&amp;multiBuffers, multiBuffer);</div></div><!-- fragment --><ul>
<li>Upon reception, data entries can be accessed by first declaring a data entry, and then using the <a class="el" href="group__buffer_api_functions.html#ga34d0923dddc433082c4d673e7331772d" title="Function to get the first entry in a MultiBuffer list. ">RCL_MultiBuffer_RxEntry_get</a> API to get the entry.</li>
</ul>
<div class="fragment"><div class="line">List_List finishedBuffers;</div><div class="line"><span class="comment">/* Prepare list of RX buffers that are done */</span></div><div class="line">List_clearList(&amp;finishedBuffers);</div><div class="line"></div><div class="line"><span class="comment">/* Read out received packet */</span></div><div class="line">RCL_Buffer_DataEntry *rxPkt = <a class="code" href="group__buffer_api_functions.html#ga34d0923dddc433082c4d673e7331772d">RCL_MultiBuffer_RxEntry_get</a>(&amp;rxCmd-&gt;rxBuffers, &amp;finishedBuffers);</div></div><!-- fragment --><ul>
<li>Clear entry or entries for reuse by the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a>. This is necessary so that after reception the MultiBuffer can be reused for storing packets, and can be accomplished by getting a list of the MultiBuffers that are done, checking which MultiBuffers are free before clearing them, and adding them back to the list.</li>
</ul>
<div class="fragment"><div class="line"><span class="comment">/* Make finished buffers available to RCL command */</span></div><div class="line"><span class="keywordflow">while</span> ((multiBuffer = <a class="code" href="group__buffer_api_functions.html#ga021359bef97c8bb6edefebaf6da855c0">RCL_MultiBuffer_get</a>(&amp;finishedBuffers)) != NULL)</div><div class="line">{</div><div class="line">    <a class="code" href="group__buffer_api_functions.html#gabbbf7364e16aae6951ee7c827de9bf06">RCL_MultiBuffer_clear</a>(multiBuffer);</div><div class="line">    <a class="code" href="group__buffer_api_functions.html#gaf9be361ce2825a10f9ee8a132f8ad920">RCL_MultiBuffer_put</a>(&amp;multiBuffers, multiBuffer);</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="rcl_architecture.html">RCL Architecture</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
