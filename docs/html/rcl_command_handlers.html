<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Radio Control Layer (RCL): Command Handlers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Radio Control Layer (RCL)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('rcl_command_handlers.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Command Handlers </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>As previously mentioned, an important part of the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> command life-cycle is what is known as the command handler. The command handler is a self-contained finite state machine that takes care of the command parameters, the payload, and the interrupt handling needed during the execution of the command (i.e. the interrupts coming from the radio and the SYSTIM). In simple terms, it is the piece of code takes care of protocol specific operations (e.g. BLE advertising), and interacts directly with the LRF.</p>
<p>The following section provides an introduction to their usage and common characteristics. For more protocol specific information, see the following pages:</p>
<ul>
<li><a class="el" href="ble_command_handlers.html">BLE Command Handlers</a></li>
<li><a class="el" href="generic_command_handlers.html">Generic Command Handlers</a></li>
<li><a class="el" href="nesb_command_handlers.html">NESB Command Handlers</a></li>
</ul>
<h1>Usage</h1>
<p>Command handlers are configured at the application level through the use of command structs. The user will normally first declare a command of a specific type (e.g. <a class="el" href="commands_2generic_8h.html#struct_r_c_l___c_m_d___g_e_n_e_r_i_c___t_x__t" title="Generic transmit command. ">RCL_CMD_GENERIC_TX_t</a> or ::RCL_CMD_BLE5_ADV), and then configure the command handler by updating the fields in the command struct.</p>
<p>As expected, the command struct will mostly include protocol specific configuration. Nevertheless, there are some configuration fields which are common to all command handlers (<a class="el" href="_r_c_l___command_8h.html#struct_r_c_l___command__s" title="General command. ">RCL_Command_s</a>).</p>
<div class="fragment"><div class="line"><span class="comment">/* Declare command */</span></div><div class="line">RCL_CmdGenericTx cmd;</div><div class="line">cmd = <a class="code" href="commands_2generic_8h.html#a8175ac610dee3e06b3b2b940a6c3ae32">RCL_CmdGenericTx_DefaultRuntime</a>();</div><div class="line"></div><div class="line"><span class="comment">/* Common configuration */</span></div><div class="line">cmd.common.scheduling = <a class="code" href="_r_c_l___command_8h.html#ade08c929505da062070474163417817da36e4eb855b1a8b435564f5911266a55b">RCL_Schedule_AbsTime</a>;</div><div class="line">cmd.common.runtime.callback = defaultCallback;</div><div class="line">cmd.common.runtime.lrfCallbackMask.value = <a class="code" href="_l_r_f_c_c23_x0_8h.html#a47f68c8084c244a4e11a8749a5ec12d3">LRF_EventRxOk</a>.value;</div><div class="line">cmd.common.runtime.rclCallbackMask = <a class="code" href="_r_c_l___event_8h.html#a9e6384116d9e2d84f36990827d6e86f1">RCL_EventLastCmdDone</a>.value | <a class="code" href="_r_c_l___event_8h.html#a27efe993ce19cd501e8aadb7c5fa4aee">RCL_EventRxEntryAvail</a>.value;;</div><div class="line"></div><div class="line"><span class="comment">/* Command-specific configuration */</span></div><div class="line">cmd.rfFrequency = 2450000000;</div><div class="line">cmd.syncWord = 0xAB0B51DE;</div><div class="line">cmd.config.fsOff = 0;</div></div><!-- fragment --><p>Part of the configuration fields common to all command handlers is the runtime information (<a class="el" href="_r_c_l___command_8h.html#struct_r_c_l___command_runtime__s" title="Command runtime structure. ">RCL_CommandRuntime_s</a>) and the timing information (<a class="el" href="_r_c_l___command_8h.html#struct_r_c_l___command_timing__s" title="Command timing structure. ">RCL_CommandTiming_s</a>).</p>
<p>The runtime information among other things allows to enable callbacks for events that come directly from the LRF or for events generated by the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a>. That is, the callback will be executed only when the appropriate event is set.</p>
<p>The timing information on the other hand allows to configure the start time (unless <a class="el" href="_r_c_l___command_8h.html#ade08c929505da062070474163417817da39c41d2c31edf75e6c226a4613d313cb">RCL_Schedule_Now</a> is used), and also stop times (graceful and hard) of the command.</p>
<h1>Architecture</h1>
<p>Regardless of the protocol, the interaction between the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> and the command handler requires four elements.</p>
<ul>
<li><a class="el" href="_r_c_l___event_8h.html#union_r_c_l___events__u">RCL_Events_u</a> going into the command handler: Signals that the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> might want to send to the command handler (for example a graceful stop or that the radio setup has been performed). This allows the command handler to determine whether it should proceed with the radio operation, reject it, or stop it.</li>
<li><a class="el" href="_r_c_l___event_8h.html#union_r_c_l___events__u">RCL_Events_u</a> coming out of the command handler: Signals that the command handler might want ot send to the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> (for example that an Rx entry has been made available or that the command handler has accepted and started executing the command).</li>
<li><a class="el" href="_l_r_f_c_c23_x0_8h.html#union_l_r_f___events__u">LRF_Events_u</a>: Radio specific events (for example that a packet has been transmitted or that a packet was received with a CRC error) used by both the <a class="el" href="_r_c_l_8h.html#struct_r_c_l" title="Global shared driver state. ">RCL</a> and the command handler.</li>
<li><a class="el" href="_r_c_l___command_8h.html#struct_r_c_l___command__s" title="General command. ">RCL_Command_s</a> common configuration: Provides the command handler with information about scheduling, the command ID, graceful stop times, conflict policy, etc.</li>
</ul>
<p>The following diagram illustrates in a simplified way how the state machine in a command handler might look:</p>
<div align="center">
<img src="inline_umlgraph_14.png" />
<div class="caption">
Basic command handler state machine</div>
</div>
<h2>Internal packet format</h2>
<p>The internal packet format refers to how packets are stored in the LRF FIFOs, and it's particularly important since regardless of the communication protocol used, the structure for both transmitted and received packet entries must be compatible with the format.</p>
<div class="image">
<img src="internal_packet_format.png" alt="internal_packet_format.png"/>
<div class="caption">
LRF Internal packet format</div></div>
<p> The following rules apply to the internal packet format:</p>
<ul>
<li>Word 0 shall always be aligned to a 32 bit address</li>
<li>Padding can be used by application to e.g. word align header, word align the payload or other points in the packet.</li>
<li>Required fields are: FIFO length (Bytes 0-1), padding length (Byte 2), and payload.</li>
<li>The optional padding must be continuous.</li>
<li>When it comes to the order in the FIFO, the optional padding is always followed by the header (if any), and the header is always followed by the payload.</li>
<li>In the case of fixed length or that the header fits in byte 3, then word 1 can be omitted.</li>
<li>The length field to be transmitted over the air must be embedded in the header written to the FIFO</li>
<li>Configurable padding (based on LRF settings) at the end of the entry which is emptied from the TX FIFO by the LRF in TX, and entered by the LRF into RX FIFO in RX.</li>
</ul>
<p>As an example, a correct packet entry for a BLE packet for transmission (or reception with no extra bytes) will be:</p>
<div class="image">
<img src="internal_packet_format_ble.png" alt="internal_packet_format_ble.png"/>
<div class="caption">
BLE packet entry example</div></div>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="rcl_architecture.html">RCL Architecture</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
